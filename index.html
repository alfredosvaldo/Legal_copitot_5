<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Copiloto Legal: Comparador Legislativo Inteligente (OpenAI)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <!-- Word export -->
  <script src="https://unpkg.com/html-docx-js/dist/html-docx.js"></script>
  <script src="https://unpkg.com/file-saver@2.0.5/dist/FileSaver.min.js"></script>
  <!-- Diff viewer -->
  <script src="https://cdn.jsdelivr.net/npm/diff@5.1.0/dist/diff.min.js"></script>
  <style>
    body { font-family: 'Inter', sans-serif; }
    #resultsTable th, #resultsTable td { border: 1px solid #ddd; padding: 8px; vertical-align: top; }
    #resultsTable th { background-color: #f2f2f2; text-align: left; }
    .loader { border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%;
              width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 2rem auto; }
    @keyframes spin { 0% { transform: rotate(0deg);} 100% { transform: rotate(360deg);} }
    ins { background-color: #d4edda; text-decoration: none; }
    del { background-color: #f8d7da; text-decoration: line-through; }
    .modal-backdrop { position: fixed; top:0; left:0; width:100%; height:100%;
                      background-color: rgba(0,0,0,0.5); display:flex; justify-content:center; align-items:center; z-index:1000; }
    .modal-content { background:white; padding:2rem; border-radius:0.5rem; text-align:center; max-width:90%; width:400px; }
    .modal-button { margin-top:1.5rem; padding:0.5rem 1.5rem; border-radius:0.375rem;
                    background:#2563eb; color:white; font-weight:600; cursor:pointer; }
  </style>
</head>
<body class="bg-gray-100 text-gray-800 flex flex-col min-h-screen">
<div class="container mx-auto p-4 md:p-8 flex-grow">
  <header class="text-center mb-8">
    <h1 class="text-3xl md:text-4xl font-bold text-gray-900">Copiloto Legal</h1>
    <p class="text-gray-600 mt-2">Su asistente para la generación de indicaciones y tablas comparativas de textos legales.</p>
  </header>

  <!-- API Key input -->
  <div class="bg-white p-6 rounded-lg shadow-md mb-6">
    <label for="apiKey" class="block text-lg font-semibold mb-2">Your OpenAI API Key</label>
    <input type="password" id="apiKey" class="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500"
           placeholder="Paste your API key here">
    <div class="flex items-center mt-2">
      <input type="checkbox" id="rememberKey" class="mr-2">
      <label for="rememberKey" class="text-sm text-gray-600">Recordar clave en este navegador</label>
    </div>
    <p class="text-sm text-gray-500 mt-1">Su clave se almacena solo en su navegador, nunca en un servidor.</p>
  </div>

  <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
    <div class="bg-white p-6 rounded-lg shadow-md">
      <h2 class="text-xl font-semibold mb-4">Texto Original Completo</h2>
      <textarea id="originalText" class="w-full h-96 p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500"
                placeholder="Pegue aquí la columna completa del texto original..."></textarea>
    </div>
    <div class="bg-white p-6 rounded-lg shadow-md">
      <h2 class="text-xl font-semibold mb-4">Texto Final Completo</h2>
      <textarea id="finalText" class="w-full h-96 p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500"
                placeholder="Pegue aquí la columna completa del texto final modificado..."></textarea>
    </div>
  </div>

  <div class="text-center my-8">
    <button id="generateButton"
      class="bg-green-600 text-white font-bold py-3 px-8 rounded-lg shadow-lg hover:bg-green-700
             focus:outline-none focus:ring-4 focus:ring-green-300 transition disabled:bg-gray-400 disabled:cursor-not-allowed">
      Generar Tabla Comparativa
    </button>
  </div>

  <div id="outputSection" class="bg-white p-6 rounded-lg shadow-md hidden">
    <div class="flex justify-between items-center mb-4">
      <h2 class="text-xl font-semibold">Resultado Comparativo
        <span id="timerResult" class="text-sm font-normal text-gray-500 ml-2"></span>
      </h2>
      <button id="exportButton"
              class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 transition">
        Exportar a Word
      </button>
    </div>
    <div id="resultsContainer" class="w-full overflow-x-auto"></div>
  </div>
</div>

<footer class="text-center p-4 text-gray-500 text-sm">
  <p>Copiloto Legal v5.0 (GPT-5 Edition) | Última actualización: 26 de Agosto, 2025</p>
</footer>

<!-- Modal -->
<div id="customAlert" class="modal-backdrop hidden">
  <div class="modal-content">
    <p id="alertMessage"></p>
    <button id="alertCloseButton" class="modal-button">Cerrar</button>
  </div>
</div>

<script>
  // === API key persistence ===
  const apiKeyInput = document.getElementById('apiKey');
  const rememberKey = document.getElementById('rememberKey');
  if (localStorage.getItem('openai_api_key')) {
    apiKeyInput.value = localStorage.getItem('openai_api_key');
    rememberKey.checked = true;
  }
  rememberKey.addEventListener('change', () => {
    if (!rememberKey.checked) localStorage.removeItem('openai_api_key');
  });

  // === UI helpers ===
  document.getElementById('generateButton').addEventListener('click', generateIndications);
  document.getElementById('exportButton').addEventListener('click', exportToWord);
  document.getElementById('alertCloseButton').addEventListener('click', () => {
    document.getElementById('customAlert').classList.add('hidden');
  });
  function showAlert(msg){document.getElementById('alertMessage').textContent=msg;
    document.getElementById('customAlert').classList.remove('hidden');}

  function parseCustomFormat(text){
    const articles=[]; const blocks=text.split('<ARTICLE_END>');
    for(const b of blocks){
      if(!b.trim()) continue;
      const o=b.match(/<ORIGINAL>([\s\S]*?)<\/ORIGINAL>/);
      const i=b.match(/<INDICACIONES>([\s\S]*?)<\/INDICACIONES>/);
      const f=b.match(/<FINAL>([\s\S]*?)<\/FINAL>/);
      if(o&&i&&f) articles.push({textoOriginal:o[1].trim(),indicaciones:i[1].trim(),textoFinal:f[1].trim()});
    } return articles;
  }

  function renderTable(articles){
    const c=document.getElementById('resultsContainer'); c.innerHTML='';
    if(!articles.length){c.innerHTML='<p class="text-red-500">No se pudieron procesar artículos.</p>'; return;}
    const table=document.createElement('table'); table.id='resultsTable'; table.className='w-full border-collapse';
    table.innerHTML='<thead><tr><th class="w-1/3 p-2 border bg-gray-100">Texto Original</th>\
                      <th class="w-1/3 p-2 border bg-gray-100">Indicaciones</th>\
                      <th class="w-1/3 p-2 border bg-gray-100">Texto Final</th></tr></thead>';
    const tbody=document.createElement('tbody');
    articles.forEach(a=>{
      const diff=Diff.diffWords(a.textoOriginal||'',a.textoFinal||'',{ignoreWhitespace:true});
      let oHtml='',fHtml=''; diff.forEach(p=>{
        const v=p.value.replace(/</g,"&lt;").replace(/>/g,"&gt;");
        if(p.added) fHtml+=`<ins>${v}</ins>`;
        else if(p.removed) oHtml+=`<del>${v}</del>`;
        else {oHtml+=v; fHtml+=v;}
      });
      const row=`<tr>
        <td class="p-2 border align-top whitespace-pre-wrap">${oHtml}</td>
        <td class="p-2 border align-top whitespace-pre-wrap">${(a.indicaciones||'').replace(/\n/g,'<br>')}</td>
        <td class="p-2 border align-top whitespace-pre-wrap">${fHtml}</td></tr>`;
      tbody.innerHTML+=row;
    });
    table.appendChild(tbody); c.appendChild(table);
    document.getElementById('outputSection').classList.remove('hidden');
  }

  async function fetchWithRetry(url,opt){
    let err;
    for(let a=0;a<5;a++){
      try{const r=await fetch(url,opt); if(r.ok) return r;
        if(r.status===429){await new Promise(res=>setTimeout(res,(2**a)*1000)); continue;}
        throw new Error(await r.text());
      }catch(e){err=e; await new Promise(res=>setTimeout(res,(2**a)*1000));}
    } throw err;
  }

  async function generateIndications(){
    const apiKey=apiKeyInput.value;
    const orig=document.getElementById('originalText').value;
    const fin=document.getElementById('finalText').value;
    const res=document.getElementById('resultsContainer');
    const sec=document.getElementById('outputSection');
    const btn=document.getElementById('generateButton');
    const timer=document.getElementById('timerResult');
    if(!apiKey) return showAlert("Ingrese su API Key");
    if(!orig.trim()||!fin.trim()) return showAlert("Pegue texto en ambas columnas");
    if(rememberKey.checked) localStorage.setItem('openai_api_key',apiKey);

    btn.disabled=true; btn.textContent="Generando...";
    sec.classList.remove('hidden'); res.innerHTML='<div class="loader"></div>'; timer.textContent='';
    const start=performance.now();

    // === PROMPT COMPLETO ===
    const prompt = `Rol: Eres un asesor legislativo experto en Chile, con especialización en técnica parlamentaria. Tu misión es generar una comparación completa, artículo por artículo, de dos textos legales, produciendo indicaciones precisas y profesionales que se adhieran estrictamente a la terminología oficial.
    
1) GLOSARIO DE TÉRMINOS (USO OBLIGATORIO)
- Verbos de acción (normativos):
• Para adicionar información: "Incorpórase", "Agrégase", "Añádese".
• Para sustituir información: "Sustitúyese", "Reemplázase".
• Para adicionar entre vocablos: "Intercálese".
• Para eliminar información: "Suprímese", "Elimínase".
• Para modificar de forma genérica: "Modifícase".
- Sustantivos para designar elementos: "el guarismo", "la expresión", "la palabra", "la frase", "la oración", "el numeral", "el literal", "el inciso", "el artículo", "el encabezado", "la sección (i), (ii), (iii)…".
- Meta-frase para iniciar cada indicación numerada (nivel principal): "Para + infinitivo" (ej.: Para reemplazar…, Para modificar…, Para agregar…). En los desgloses a), b), c) usa solo los verbos normativos del glosario.

2) REGLAS DE ORO (MÁXIMA PRIORIDAD)
- Numeración correlativa global: la secuencia 1), 2), 3)… es continua a lo largo de TODO el documento (no se reinicia por artículo).
- Procesar todo y en orden: recorre los textos de principio a fin y genera un bloque para CADA artículo.
- Encabezado único por artículo (obligatorio): Dentro de <INDICACIONES>, escribe una sola vez la línea: AL ARTÍCULO [nombre completo] (sin dos puntos al final) y debajo coloca todas las indicaciones numeradas aplicables a ese artículo. "Nombre completo" = denominación exacta (p. ej., "Artículo 11", "Artículo tercero transitorio", ordinales/letras/romanos y/o epígrafe).
- Agrupación de cambios:
• Genera UNA indicación por unidad afectada (inciso, numeral, literal, sección, encabezado, “nuevo inciso [ordinal] introducido al artículo X”, etc.).
• Si varios cambios coherentes afectan una MISMA unidad (o varias partes del mismo artículo bajo un objetivo común), puedes agruparlos en UNA sola indicación usando la frase: "en el siguiente sentido:" y desglosando con a), b), c)… (usando verbos normativos).

3) FORMATO DE SALIDA ESTRICTO (OBLIGATORIO)
Toda la respuesta debe usar estas etiquetas (no uses JSON).
<ARTICLE_START>
<ORIGINAL>...texto original aquí (si aplica)...</ORIGINAL>
<INDICACIONES>
AL ARTÍCULO [nombre completo]
1) Para [verbo en infinitivo] ...
2) Para [verbo en infinitivo] ...
a) [Verbo normativo] ...
b) [Verbo normativo] ...
3) Para [verbo en infinitivo] ...
</INDICACIONES>
<FINAL>...texto final aquí (si aplica)...</FINAL>
<ARTICLE_END>
... (repetir para cada artículo) ...

Si no hay cambios para un artículo, deja <INDICACIONES> vacío (sin encabezado ni numerales).

4) PROCESO DE ANÁLISIS SECUENCIAL E ITERATIVO
Paso 1 — Identificar artículo: toma el siguiente en secuencia (p. ej., "Artículo 2°", "Artículo tercero transitorio").
Paso 2 — Determinar el caso:
CASO A: MODIFICACIÓN (existe en ambos textos con el mismo número)
- Regla de agrupación:
• Una indicación por unidad afectada (inciso, numeral, literal, sección, encabezado…).
• Si hay múltiples cambios en la MISMA unidad, usa: N) Para modificar [la unidad] en el siguiente sentido: a) [Verbo normativo] ... b) [Verbo normativo] ...
- Plantillas:
• N) Para reemplazar en el [inciso/numeral/literal/sección (ii)] [del artículo X], el guarismo "___" por "___".
• N) Para agregar, en el [inciso/numeral/literal], a continuación de "___", la frase "___".
• N) Para modificar [inciso primero] en el siguiente sentido: a) Suprímese la expresión "___". b) Incorpórase, entre "___" y "___", la frase "___".
CASO B: ARTÍCULO NUEVO (solo en el Texto Final)
- <ORIGINAL> vacío.
- <INDICACIONES>: AL ARTÍCULO [nombre completo] N) Para agregar el siguiente artículo [nombre completo], nuevo, del siguiente tenor: "___".
- <FINAL> contiene el texto completo nuevo.
CASO C: ARTÍCULO ELIMINADO (solo en el Texto Original)
- <ORIGINAL> contiene el texto del artículo.
- <INDICACIONES>: AL ARTÍCULO [nombre completo] N) Para suprimir el artículo [nombre completo].
- <FINAL> vacío.
CASO D: RENUMERACIÓN (contenido del "Artículo X" original es idéntico al del "Artículo Y" final)
- <ORIGINAL> contiene el texto del artículo X.
- <INDICACIONES>: AL ARTÍCULO [nombre completo del original X] N) Para consignar que el artículo X ha pasado a ser artículo Y.
- <FINAL> contiene el texto del artículo Y.
Paso 3 — Construir bloque de salida: encierra cada resultado en <ARTICLE_START> … <ARTICLE_END>.
Paso 4 — Continuar: al cerrar <ARTICLE_END>, procesa de inmediato el siguiente artículo.

5) REGLA FINAL DE COMPLETITUD
No te detengas hasta procesar TODOS los artículos del Texto Original y del Texto Final. Continúa generando bloques <ARTICLE_START>…<ARTICLE_END> hasta cubrir ambos completamente.

6) TEXTOS A PROCESAR
Texto Original: ${orig}
Texto Final: ${fin}`;

    try{
      const r=await fetchWithRetry("https://api.openai.com/v1/chat/completions",{
        method:'POST',
        headers:{'Content-Type':'application/json','Authorization':`Bearer ${apiKey}`},
        body:JSON.stringify({model:"gpt-5",messages:[{role:"user",content:prompt}]})
      });
      const j=await r.json(); const text=j?.choices?.[0]?.message?.content;
      if(!text) throw new Error("Respuesta vacía");
      renderTable(parseCustomFormat(text));
      timer.textContent=`Generado en ${((performance.now()-start)/1000).toFixed(2)}s`;
    }catch(e){
      res.innerHTML=`<p class="text-red-500">Error: ${e.message}</p>`;
    }finally{btn.disabled=false; btn.textContent="Generar Tabla Comparativa";}
  }

  function exportToWord(){
    const t=document.getElementById('resultsTable'); if(!t) return showAlert("No hay resultados");
    const clone=t.cloneNode(true);
    clone.querySelectorAll('br').forEach(br=>br.parentNode.replaceChild(document.createTextNode('\n'),br));
    const html=`<!DOCTYPE html><html><head><meta charset="UTF-8">
      <style>body{font-family:'Times New Roman'} table{border-collapse:collapse;width:100%}
      th,td{border:1px solid black;padding:8px;white-space:pre-wrap}</style></head>
      <body><h1>Tabla Comparativa</h1>${clone.outerHTML}</body></html>`;
    saveAs(htmlDocx.asBlob(html),"Tabla_Comparativa_Indicaciones.docx");
  }
</script>
</body>
</html>
