<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Copiloto Legal FT — Comparador Legislativo (OpenAI)</title>

  <!-- Tailwind (UI) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <!-- Librerías: exportar a Word y diff -->
  <script src="https://unpkg.com/html-docx-js/dist/html-docx.js"></script>
  <script src="https://unpkg.com/file-saver@2.0.5/dist/FileSaver.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/diff@5.1.0/dist/diff.min.js"></script>

  <style>
    body { font-family: 'Inter', sans-serif; }
    #resultsTable th, #resultsTable td { border: 1px solid #e5e7eb; padding: 10px; vertical-align: top; }
    #resultsTable th { background: #f8fafc; text-align: left; }
    ins { background-color: #d4edda; text-decoration: none; }
    del { background-color: #f8d7da; text-decoration: line-through; }
    .loader { border: 4px solid #f3f3f3; border-top: 4px solid #2563eb; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 2rem auto; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
  </style>
</head>
<body class="bg-gray-100 text-gray-800 min-h-screen flex flex-col">

  <div class="container mx-auto p-4 md:p-8 flex-1">
    <header class="mb-6">
      <h1 class="text-3xl md:text-4xl font-bold">Copiloto Legal (Fine-tuned)</h1>
      <p class="text-gray-600 mt-2">Comparación artículo-por-artículo, indicaciones y tabla con resaltado de cambios.</p>
    </header>

    <!-- Panel de configuración -->
    <section class="bg-white p-5 rounded-lg shadow mb-6 grid gap-4 md:grid-cols-2">
      <div>
        <label class="block font-semibold mb-2">OpenAI API Key</label>
        <input type="password" id="apiKey" class="w-full p-3 border rounded-md focus:ring-2 focus:ring-blue-500"
               placeholder="Pega tu API key" />
        <p class="text-sm text-gray-500 mt-1">Se usa solo en tu navegador (no se envía a ningún servidor propio).</p>
      </div>
      <div>
        <label class="block font-semibold mb-2">Modelo (opcional)</label>
        <input type="text" id="modelName" class="w-full p-3 border rounded-md focus:ring-2 focus:ring-blue-500 mono"
               placeholder="ft:..." />
        <p class="text-sm text-gray-500 mt-1">
          Pre-rellenado con tu modelo FT. Si lo vacías, usaremos el base model recomendado.
        </p>
      </div>
      <div class="md:col-span-2 flex items-center gap-3">
        <input id="remember" type="checkbox" class="h-4 w-4" checked />
        <label for="remember" class="text-sm text-gray-700">Recordar API key y modelo en este navegador</label>
      </div>
    </section>

    <!-- Entradas de texto -->
    <section class="grid gap-6 md:grid-cols-2">
      <div class="bg-white p-5 rounded-lg shadow">
        <div class="flex items-center justify-between mb-3">
          <h2 class="text-xl font-semibold">Texto Original (completo)</h2>
          <button id="pasteOriginal" class="text-sm text-blue-600 hover:underline">Pegar</button>
        </div>
        <textarea id="originalText" class="w-full h-96 p-3 border rounded-md focus:ring-2 focus:ring-blue-500"
                  placeholder="Pega aquí el texto original completo…"></textarea>
      </div>

      <div class="bg-white p-5 rounded-lg shadow">
        <div class="flex items-center justify-between mb-3">
          <h2 class="text-xl font-semibold">Texto Final (completo)</h2>
          <button id="pasteFinal" class="text-sm text-blue-600 hover:underline">Pegar</button>
        </div>
        <textarea id="finalText" class="w-full h-96 p-3 border rounded-md focus:ring-2 focus:ring-blue-500"
                  placeholder="Pega aquí el texto final completo…"></textarea>
      </div>
    </section>

    <!-- Acciones -->
    <div class="flex flex-wrap gap-3 justify-center my-8">
      <button id="generateButton"
              class="bg-green-600 text-white font-bold py-3 px-6 rounded-lg shadow hover:bg-green-700 focus:ring-4 focus:ring-green-300 disabled:bg-gray-400">
        Generar tabla comparativa
      </button>
      <button id="exportButton"
              class="bg-blue-600 text-white font-bold py-3 px-6 rounded-lg shadow hover:bg-blue-700"
              title="Exporta el resultado a Word (.docx)">Exportar a Word</button>
      <button id="clearButton"
              class="bg-gray-200 text-gray-800 font-semibold py-3 px-6 rounded-lg shadow hover:bg-gray-300">
        Limpiar
      </button>
    </div>

    <!-- Resultados -->
    <section id="outputSection" class="bg-white p-5 rounded-lg shadow hidden">
      <div class="flex items-center justify-between mb-3">
        <h3 class="text-xl font-semibold">Resultado <span id="timerResult" class="text-sm font-normal text-gray-500 ml-2"></span></h3>
        <span id="modelUsed" class="text-xs text-gray-500 mono"></span>
      </div>
      <div id="resultsContainer" class="w-full overflow-x-auto"></div>
    </section>

    <!-- Errores -->
    <div id="errorBox" class="hidden mt-4 p-4 rounded bg-red-50 border border-red-200 text-red-700"></div>
  </div>

  <footer class="text-center p-4 text-gray-500 text-sm">
    Copiloto Legal v5.0 (FT) — Cliente 100% local. Última actualización: 23 Ago 2025.
  </footer>

<script>
/* ===========================
   Utilidades UI
   =========================== */
const $ = (id) => document.getElementById(id);
const defaultFTModel = "ft:gpt-4.1-mini-2025-04-14:personal:copiloto-legal-fine:C7rwpGL7";
const baseFallbackModel = "gpt-4.1-mini-2025-04-14"; // por si quieres probar sin FT

// Cargar preferencias guardadas
(function boot(){
  const savedKey   = localStorage.getItem("openai_key");
  const savedModel = localStorage.getItem("openai_model");
  if (savedKey)   $("apiKey").value = savedKey;
  $("modelName").value = savedModel || defaultFTModel;
})();

$("remember").addEventListener("change", (e)=>{
  if (!e.target.checked) {
    localStorage.removeItem("openai_key");
    localStorage.removeItem("openai_model");
  }
});

$("pasteOriginal").onclick = async () => {
  try { $("originalText").value = await navigator.clipboard.readText(); } catch {}
};
$("pasteFinal").onclick = async () => {
  try { $("finalText").value = await navigator.clipboard.readText(); } catch {}
};

$("clearButton").onclick = () => {
  $("resultsContainer").innerHTML = "";
  $("outputSection").classList.add("hidden");
  $("timerResult").textContent = "";
  $("errorBox").classList.add("hidden");
};

/* ===========================
   Validación de salida (STRICT)
   =========================== */
function isWellFormedResponse(txt){
  return /<ARTICLE_START>/i.test(txt) &&
         /<ARTICLE_END>/i.test(txt) &&
         /<ORIGINAL>[\s\S]*<\/ORIGINAL>/i.test(txt) &&
         /<INDICACIONES>[\s\S]*<\/INDICACIONES>/i.test(txt) &&
         /<FINAL>[\s\S]*<\/FINAL>/i.test(txt);
}

/* ===========================
   Parser del formato etiquetado
   =========================== */
function parseCustomFormat(responseText) {
  const blocks = responseText.split(/<ARTICLE_END>/i);
  const articles = [];
  for (const raw of blocks) {
    const block = raw.trim();
    if (!block) continue;
    const orig = (block.match(/<ORIGINAL>([\s\S]*?)<\/ORIGINAL>/i) || [])[1] || "";
    const inds = (block.match(/<INDICACIONES>([\s\S]*?)<\/INDICACIONES>/i) || [])[1] || "";
    const fin  = (block.match(/<FINAL>([\s\S]*?)<\/FINAL>/i) || [])[1] || "";
    if (orig.length + inds.length + fin.length === 0) continue;
    articles.push({
      original: orig.trim(),
      indicaciones: sanitize(inds.trim()),
      final: fin.trim()
    });
  }
  return articles;
}

/* ===========================
   Render de la tabla con diff
   =========================== */
function renderTable(articles) {
  const container = $("resultsContainer");
  container.innerHTML = "";
  if (!articles || articles.length === 0) {
    container.innerHTML = `<p class="text-red-500">No se encontraron artículos en la respuesta del modelo.</p>`;
    return;
  }
  const table = document.createElement("table");
  table.id = "resultsTable";
  table.className = "w-full border-collapse text-sm md:text-base";

  table.innerHTML = `
    <thead>
      <tr>
        <th class="w-1/3">Texto Original (con diffs)</th>
        <th class="w-1/3">Indicaciones</th>
        <th class="w-1/3">Texto Final (con diffs)</th>
      </tr>
    </thead>
    <tbody></tbody>
  `;
  const tbody = table.querySelector("tbody");

  articles.forEach((a) => {
    const diff = Diff.diffWords(a.original || "", a.final || "", { ignoreWhitespace: true });
    let oHtml = "", fHtml = "";
    diff.forEach(part => {
      const safe = escapeHtml(part.value);
      if (part.added) fHtml += `<ins>${safe}</ins>`;
      else if (part.removed) oHtml += `<del>${safe}</del>`;
      else { oHtml += safe; fHtml += safe; }
    });
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td class="align-top whitespace-pre-wrap">${oHtml}</td>
      <td class="align-top whitespace-pre-wrap">${a.indicaciones}</td>
      <td class="align-top whitespace-pre-wrap">${fHtml}</td>
    `;
    tbody.appendChild(tr);
  });

  container.appendChild(table);
  $("outputSection").classList.remove("hidden");
}

/* ===========================
   Exportar a Word
   =========================== */
$("exportButton").onclick = () => {
  const table = $("resultsTable");
  if (!table) { showError("No hay resultados para exportar."); return; }

  const content = `
  <!DOCTYPE html>
  <html><head><meta charset="UTF-8">
    <style>
      body{font-family: 'Times New Roman', Times, serif;}
      table{border-collapse: collapse; width: 100%;}
      th,td{border:1px solid #000; padding:8px; vertical-align:top; white-space:pre-wrap;}
      th{background:#f2f2f2;}
      ins{background:#d4edda; text-decoration:none; color:#000;}
      del{background:#f8d7da; text-decoration:line-through; color:#000;}
    </style>
  </head><body>
    <h1>Tabla Comparativa de Indicaciones</h1>
    ${table.outerHTML}
  </body></html>`;
  const blob = htmlDocx.asBlob(content);
  saveAs(blob, "Tabla_Comparativa_Indicaciones.docx");
};

/* ===========================
   Llamada a OpenAI (Chat Completions)
   =========================== */
$("generateButton").onclick = generate;

async function generate() {
  hideError();
  const key = $("apiKey").value.trim();
  const model = ($("modelName").value.trim()) || baseFallbackModel;
  const original = $("originalText").value.trim();
  const finalTxt = $("finalText").value.trim();

  if (!key) return showError("Ingresa tu OpenAI API key.");
  if (!original || !finalTxt) return showError("Pega texto en ambas columnas.");

  if ($("remember").checked) {
    localStorage.setItem("openai_key", key);
    localStorage.setItem("openai_model", model);
  }

  $("generateButton").disabled = true;
  $("generateButton").textContent = "Generando…";
  $("outputSection").classList.remove("hidden");
  $("resultsContainer").innerHTML = '<div class="loader"></div>';
  $("timerResult").textContent = "";
  $("modelUsed").textContent = "";
  const t0 = performance.now();

  const systemPrompt = [
    "Eres un asesor legislativo experto en técnica parlamentaria chilena.",
    "Analiza dos textos (Original y Final) y produce la comparación COMPLETA, artículo por artículo.",
    "Entrega únicamente bloques etiquetados EXACTOS, sin explicaciones ni pasos intermedios:",
    "<ARTICLE_START>",
    "<ORIGINAL>…</ORIGINAL>",
    "<INDICACIONES>",
    "AL ARTÍCULO [nombre completo]",
    "1) Para [verbo en infinitivo] …",
    "   a) [Verbo normativo] …",
    "</INDICACIONES>",
    "<FINAL>…</FINAL>",
    "<ARTICLE_END>",
    "Procesa TODOS los artículos; numeración correlativa global; maneja casos: modificación, nuevo, eliminado, renumeración."
  ].join("\n");

  const userPrompt = `Texto Original:\n${original}\n\nTexto Final:\n${finalTxt}`;

  const payload = {
    model,
    messages: [
      { role: "system", content: systemPrompt },
      { role: "user",   content: userPrompt }
    ],
    temperature: 0.1
  };

  try {
    const res = await chatWithRetry(payload, key);
    const data = await res.json();
    const txt = data?.choices?.[0]?.message?.content || "";

    if (!txt) throw new Error("La API no devolvió contenido.");
    if (!isWellFormedResponse(txt)) {
      throw new Error("La salida no cumple el formato etiquetado esperado.");
    }

    // Procesar (antes de mostrar)
    const articles = parseCustomFormat(txt);

    // Render (después del parseo completo)
    renderTable(articles);

    const t1 = performance.now();
    $("timerResult").textContent = `(generado en ${(t1 - t0)/1000 | 0}s)`;
    $("modelUsed").textContent = `Modelo: ${model}`;
  } catch (err) {
    // Intento de fallback: si falló con FT, pruebo base model automáticamente
    if (model !== baseFallbackModel) {
      try {
        const res2 = await chatWithRetry({ ...payload, model: baseFallbackModel }, key);
        const data2 = await res2.json();
        const txt2 = data2?.choices?.[0]?.message?.content || "";
        if (!txt2 || !isWellFormedResponse(txt2)) {
          throw new Error("El fallback al modelo base tampoco produjo formato válido.");
        }
        const articles2 = parseCustomFormat(txt2);
        renderTable(articles2);
        const t1 = performance.now();
        $("timerResult").textContent = `(generado en ${(t1 - t0)/1000 | 0}s)`;
        $("modelUsed").textContent = `Modelo: ${baseFallbackModel} (fallback)`;
        return;
      } catch (inner) {
        showError(inner.message || String(inner));
      }
    } else {
      showError(err.message || String(err));
    }
  } finally {
    $("generateButton").disabled = false;
    $("generateButton").textContent = "Generar tabla comparativa";
  }
}

async function chatWithRetry(payload, apiKey, maxRetries=4){
  const url = "https://api.openai.com/v1/chat/completions";
  let lastErr;
  for (let i=0;i<=maxRetries;i++){
    try{
      const res = await fetch(url, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "Authorization": `Bearer ${apiKey}`
        },
        body: JSON.stringify(payload)
      });
      if (res.ok) return res;
      if (res.status === 429 || res.status >= 500){
        // backoff exponencial
        const wait = Math.min(16000, (2 ** i) * 1000) + Math.floor(Math.random()*500);
        await new Promise(r=>setTimeout(r, wait));
        lastErr = new Error(`Reintentando por ${res.status}…`);
        continue;
      }
      const text = await res.text();
      throw new Error(`Error ${res.status}: ${text}`);
    }catch(e){
      lastErr = e;
      const wait = Math.min(16000, (2 ** i) * 1000);
      await new Promise(r=>setTimeout(r, wait));
    }
  }
  throw lastErr;
}

/* ===========================
   Helpers
   =========================== */
function showError(msg){
  const box = $("errorBox");
  box.textContent = msg;
  box.classList.remove("hidden");
}
function hideError(){ $("errorBox").classList.add("hidden"); }
function escapeHtml(s){ return s.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;"); }
function sanitize(s){
  // Convertir saltos de línea a <br> para visualización agradable
  return escapeHtml(s).replace(/\n/g,"<br>");
}
</script>
</body>
</html>
